import express from "express";
import multer from "multer";
import path from "path";
import mysql from "mysql2";
import cors from "cors";
import helmet from "helmet";
import dotenv from "dotenv";

dotenv.config();

// ---------------------- Multer: File Uploads ----------------------
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    let folder = "photos";

    if (file.fieldname === "voterid_image") {
      folder = "voter";
    } else if (file.fieldname === "aadhaar_image") {
      folder = "aadhaar";
    } else if (file.fieldname === "payment_ss") {
      folder = "payments";
    } else if (file.fieldname === "photo") {
      folder = "photos";
    }

    cb(null, `/var/www/mpl/uploads/${folder}`);
  },
  filename: (req, file, cb) => {
    const ext = path.extname(file.originalname);
    const unique = Date.now() + "-" + Math.round(Math.random() * 1e9);
    cb(null, `${file.fieldname}-${unique}${ext}`);
  },
});

const fileFilter = (req, file, cb) => {
  if (file.mimetype && file.mimetype.startsWith("image/")) {
    cb(null, true);
  } else {
    cb(new Error("Only image files are allowed"), false);
  }
};

const upload = multer({ storage, fileFilter });

// ---------------------- Express & Middleware ----------------------
const app = express();
app.use(express.json());
app.use(cors());
app.use(helmet());

// ---------------------- MySQL Connection ----------------------
const db = mysql.createConnection({
  host: "localhost",
  user: "hemanth",
  password: "Virat@1845",
  database: "mpl_tournament",
});

db.connect((err) => {
  if (err) {
    console.error("âŒ Database connection failed:", err);
  } else {
    console.log("âœ… Connected to MySQL database");
  }
});

// ---------------------- Health Check ----------------------
app.get("/health", (req, res) => {
  res.json({ status: "Server running fine ðŸ’ª" });
});

// ---------------------- Registration Handler ----------------------
const handleRegistration = (req, res) => {
  try {
    const {
      name,
      age,
      category,
      phone,
      address,
      jersey_number,
      jersey_size,
      voterid,
      aadhaar_number,
      txn_id,
    } = req.body;

    const files = req.files || {};

    const photo = files.photo?.[0]?.filename || null;
    const voterid_image = files.voterid_image?.[0]?.filename || null;
    const aadhaar_image = files.aadhaar_image?.[0]?.filename || null;
    const payment_ss = files.payment_ss?.[0]?.filename || null;

    const sql = `
      INSERT INTO players
      (name, age, category, phone, address,
       jersey_number, jersey_size,
       voterid, voterid_image,
       aadhaar_number, aadhaar_image,
       photo, payment_ss,
       txn_id, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `;

    db.query(
      sql,
      [
        name,
        age,
        category,
        phone,
        address,
        jersey_number,
        jersey_size,
        voterid,
        voterid_image,
        aadhaar_number,
        aadhaar_image,
        photo,
        payment_ss,
        txn_id,
      ],
      (err, result) => {
        if (err) {
          console.error("âŒ DB Insert Error:", err);

          if (err.code === "ER_DUP_ENTRY") {
            let msg = "Duplicate entry â€“ already registered.";

            if (err.message.includes("aadhaar_number")) {
              msg = "This Aadhaar number is already registered.";
            } else if (err.message.includes("voterid")) {
              msg = "This Voter ID is already registered.";
            } else if (err.message.includes("txn_id")) {
              msg = "This Transaction ID is already used.";
            }

            return res.status(400).json({ error: msg });
          }

          return res.status(500).json({ error: "Database error" });
        }

        res.json({ message: "Registration submitted successfully!" });
      }
    );
  } catch (error) {
    console.error("âŒ Upload Error:", error);
    res.status(500).json({ error: "Upload failed" });
  }
};

// Support BOTH /register (old) and /api/register (through nginx)
app.post(
  "/register",
  upload.fields([
    { name: "photo", maxCount: 1 },
    { name: "voterid_image", maxCount: 1 },
    { name: "aadhaar_image", maxCount: 1 },
    { name: "payment_ss", maxCount: 1 },
  ]),
  handleRegistration
);

app.post(
  "/api/register",
  upload.fields([
    { name: "photo", maxCount: 1 },
    { name: "voterid_image", maxCount: 1 },
    { name: "aadhaar_image", maxCount: 1 },
    { name: "payment_ss", maxCount: 1 },
  ]),
  handleRegistration
);

// ---------------------- Approved Players (Public) ----------------------
const approvedPlayersHandler = (req, res) => {
  const sql = `
    SELECT id, name, age, jersey_size, category, phone, address, photo
    FROM players
    WHERE status IN ('Approved', 'APPROVED')
    ORDER BY id DESC
  `;

  db.query(sql, (err, results) => {
    if (err) {
      console.error("âŒ Error fetching approved players:", err);
      return res.status(500).json({ error: "Database error" });
    }
    res.json(results);
  });
};

// For direct Node access
app.get("/approved-players", approvedPlayersHandler);
// For frontend via nginx (/api/â€¦)
app.get("/api/approved-players", approvedPlayersHandler);

// ---------------------- Admin: Login ----------------------
app.post("/api/admin/login", (req, res) => {
  const { username, password } = req.body;

  // Hard-coded admin credentials
  if (username === "admin" && password === "Virat@1845") {
    return res.json({ success: true });
  }

  return res.status(401).json({ success: false, message: "Invalid credentials" });
});

// ---------------------- Admin: Pending Registrations ----------------------
const pendingHandler = (req, res) => {
  const sql = `
    SELECT
      id,
      name,
      age,
      jersey_size,
      category,
      phone,
      address,
      photo,
      voterid_image,
      aadhaar_image,
      payment_ss,
      status
    FROM players
    WHERE status IN ('pending', 'PENDING')
    ORDER BY id DESC
  `;

  db.query(sql, (err, rows) => {
    if (err) {
      console.error("Error fetching pending registrations:", err);
      return res.status(500).json({ error: "Database error" });
    }
    res.json(rows);
  });
};

app.get("/admin/pending-registrations", pendingHandler);
app.get("/api/admin/pending-registrations", pendingHandler);

// ---------------------- Admin: Approve / Reject ----------------------
const approveHandler = (req, res) => {
  const id = req.params.id;

  db.query(
    "UPDATE players SET status = 'Approved' WHERE id = ?",
    [id],
    (err, result) => {
      if (err) {
        console.error("Error approving registration:", err);
        return res.status(500).json({ error: "Database error" });
      }

      if (result.affectedRows === 0) {
        return res.status(404).json({ error: "Player not found" });
      }

      res.json({ success: true });
    }
  );
};

const rejectHandler = (req, res) => {
  const id = req.params.id;

  db.query(
    "UPDATE players SET status = 'Rejected' WHERE id = ?",
    [id],
    (err, result) => {
      if (err) {
        console.error("Error rejecting registration:", err);
        return res.status(500).json({ error: "Database error" });
      }

      if (result.affectedRows === 0) {
        return res.status(404).json({ error: "Player not found" });
      }

      res.json({ success: true });
    }
  );
};

app.post("/admin/approve/:id", approveHandler);
app.post("/api/admin/approve/:id", approveHandler);

app.post("/admin/reject/:id", rejectHandler);
app.post("/api/admin/reject/:id", rejectHandler);

// ---------------------- Admin: Delete Approved Player ----------------------
const deleteApprovedHandler = (req, res) => {
  const id = req.params.id;

  // Only delete if currently approved
  db.query(
    "DELETE FROM players WHERE id = ? AND status IN ('Approved', 'APPROVED')",
    [id],
    (err, result) => {
      if (err) {
        console.error("Error deleting approved player:", err);
        return res.status(500).json({ error: "Database error" });
      }

      if (result.affectedRows === 0) {
        return res
          .status(404)
          .json({ error: "Approved player not found or already deleted" });
      }

      res.json({ success: true });
    }
  );
};

app.post("/admin/delete-player/:id", deleteApprovedHandler);
app.post("/api/admin/delete-player/:id", deleteApprovedHandler);

// ===================== ADMIN â€“ APPROVED PLAYERS =======================

// Admin: get all approved players (for delete view)
app.get("/api/admin/approved-players", (req, res) => {
  const sql = `
    SELECT id, name, age, jersey_size, category, phone, address, photo
    FROM players
    WHERE status = 'Approved'
    ORDER BY id DESC
  `;

  db.query(sql, (err, results) => {
    if (err) {
      console.error("âŒ Error fetching admin approved players:", err);
      return res.status(500).json({ error: "Database error" });
    }
    res.json(results);
  });
});

// Admin: delete an approved player
app.delete("/api/admin/approved-players/:id", (req, res) => {
  const id = req.params.id;

  const sql = `DELETE FROM players WHERE id = ? AND status = 'Approved'`;

  db.query(sql, [id], (err, result) => {
    if (err) {
      console.error("âŒ Error deleting approved player:", err);
      return res.status(500).json({ error: "Database error" });
    }

    if (result.affectedRows === 0) {
      // Either player not found or not in Approved state
      return res.status(404).json({ error: "Approved player not found" });
    }

    res.json({ success: true });
  });
});

// ---------------------- Start Server ----------------------
app.listen(3001, () => {
  console.log("ðŸš€ MPL Backend running on port 3001");
});
