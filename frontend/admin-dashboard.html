<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>MPL 2026 â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at top, #001f3f 0%, #003366 40%, #002244 100%);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    nav {
      width: 100%;
      background: #05060a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 30px;
      border-bottom: 2px solid #ffd700;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 50px;
    }

    .site-title {
      font-size: 1.7em;
      margin: 0;
      color: #ffd700;
    }

    .menu a {
      color: #ffd700;
      text-decoration: none;
      margin-left: 15px;
      font-weight: 600;
    }

    .menu a:hover {
      color: #ffffff;
    }

    h1 {
      margin-top: 20px;
    }

    .tabs {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    .tab-btn {
      padding: 8px 15px;
      border-radius: 20px;
      background: #1f3b69;
      color: white;
      cursor: pointer;
      border: none;
    }

    .tab-btn.active {
      background: #ffd700;
      color: #002244;
    }

    .card {
      width: 95%;
      max-width: 1200px;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      margin-top: 20px;
      border-radius: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: white;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      white-space: nowrap;
    }

    th {
      color: #ffd700;
    }

    .photo-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ffd700;
    }

    .btn {
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      border: none;
    }

    .btn-approve { background: #4CAF50; color: white; }
    .btn-reject { background: #e53935; color: white; }
    .btn-delete { background: #b71c1c; color: white; }
    .btn-whatsapp { background: #25D366; color: #000; }

    a.img-link { color: #4fc3f7; }
  </style>
</head>

<body>

  <nav>
    <div class="header">
      <img src="/images/logo.png" class="logo" />
      <h1 class="site-title">MPL 2026 â€“ Admin</h1>
    </div>
    <div class="menu">
      <a href="/index.html">Home</a>
      <a href="/register.html">Register</a>
      <a href="/approved.html">Approved Players</a>
      <a href="/news.html">News</a>
      <a href="/schedule.html">Schedule</a>
      <a href="/teams.html">Teams</a>
      <a href="/admin.html">Admin</a>
    </div>
  </nav>

  <h1>Admin Dashboard</h1>

  <div class="tabs">
    <button class="tab-btn active" id="tabPendingBtn">Pending</button>
    <button class="tab-btn" id="tabApprovedBtn">Approved</button>
  </div>

  <!-- PENDING CARD -->
  <div class="card" id="pendingCard">
    <h2>ðŸ•’ Pending Registrations</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Photo</th>
          <th>Name</th>
          <th>Age</th>
          <th>Jersey Size</th>
          <th>Category</th>
          <th>Phone</th>
          <th>Address</th>
          <th>Voter</th>
          <th>Aadhaar</th>
          <th>Payment</th>
<th>Txn ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="pendingBody">
        <tr><td colspan="12">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- APPROVED CARD -->
  <div class="card" id="approvedCard" style="display:none;">
    <h2>âœ… Approved Players</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Photo</th>
          <th>Name</th>
          <th>Age</th>
          <th>Jersey Size</th>
          <th>Category</th>
          <th>Phone</th>
          <th>Address</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="adminApprovedBody">
        <tr><td colspan="9">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <script>

    function normalizePhone(phone) {
      if (!phone) return null;
      let d = phone.toString().replace(/\D/g, "");
      if (d.startsWith("0")) d = d.slice(1);
      if (d.length === 10) d = "91" + d;
      return d;
    }

    function sendWhatsApp(phone, message) {
      const number = normalizePhone(phone);
      const url = `https://wa.me/${number}?text=${encodeURIComponent(message)}`;
      window.open(url, "_blank");
    }

    function imgOrDash(file) {
      if (!file) return "-";
      const safe = encodeURIComponent(file);
      return `<a class="img-link" href="/uploads/${safe}" target="_blank">View</a>`;
    }

    // LOAD PENDING
    async function loadPending() {
      const res = await fetch("/api/admin/pending-registrations");
      const data = await res.json();
      const body = document.getElementById("pendingBody");
      body.innerHTML = "";

      if (!data.length) {
        body.innerHTML = `<tr><td colspan="12">No pending registrations.</td></tr>`;
        return;
      }

      data.forEach((p, i) => {
        const photoHtml = p.photo
          ? `<img src="/uploads/${encodeURIComponent(p.photo)}" class="photo-thumb" />`
          : "-";

        body.innerHTML += `
          <tr data-player-id="${p.id}" data-player-name="${p.name}" data-player-phone="${p.phone}">
            <td>${i + 1}</td>
            <td>${photoHtml}</td>
            <td>${p.name}</td>
            <td>${p.age}</td>
            <td>${p.jersey_size}</td>
            <td>${p.category}</td>
            <td>${p.phone}</td>
            <td>${p.address}</td>
            <td>${imgOrDash(p.voterid_image)}</td>
            <td>${imgOrDash(p.aadhaar_image)}</td>
<td>${imgOrDash(p.payment_ss)}</td>
<td><b>${p.txn_id || "-"}</b></td>
<td class="actions">
            <td>
              <button class="btn btn-approve" onclick="approvePlayer(${p.id})">Approve</button>
              <button class="btn btn-reject" onclick="rejectPlayer(${p.id})">Reject</button>
              <button class="btn btn-whatsapp" onclick="notifyPlayer('${p.phone}','${p.name.replace(/'/g, "\\'")}')">WhatsApp</button>
            </td>
          </tr>
        `;
      });
    }

    // LOAD APPROVED
    async function loadApprovedAdmin() {
      const res = await fetch("/api/admin/approved-players");
      const data = await res.json();
      const body = document.getElementById("adminApprovedBody");
      body.innerHTML = "";

      if (!data.length) {
        body.innerHTML = `<tr><td colspan="9">No approved players yet.</td></tr>`;
        return;
      }

      data.forEach((p, i) => {
        const photoHtml = p.photo
          ? `<img src="/uploads/${encodeURIComponent(p.photo)}" class="photo-thumb" />`
          : "-";

        body.innerHTML += `
          <tr data-player-id="${p.id}">
            <td>${i + 1}</td>
            <td>${photoHtml}</td>
            <td>${p.name}</td>
            <td>${p.age}</td>
            <td>${p.jersey_size}</td>
            <td>${p.category}</td>
            <td>${p.phone}</td>
            <td>${p.address}</td>
            <td><button class="btn btn-delete" onclick="deleteApprovedPlayer(${p.id})">Delete</button></td>
          </tr>
        `;
      });
    }

    // WHATSAPP MESSAGE
    function notifyPlayer(phone, name) {
      const msg =
        `à²ªà³à²°à²¿à²¯ ${name},\n\n` +
        `à²¨à²¿à²®à³à²® MPL 2026 à²¨à³‹à²‚à²¦à²£à²¿ à²¸à³à²¥à²¿à²¤à²¿à²¯à²¨à³à²¨à³ à²¨à²¾à²µà³ à²¨à²µà³€à²•à²°à²¿à²¸à²¿à²¦à³à²¦à³‡à²µà³†.\n` +
        `à²¦à²¯à²µà²¿à²Ÿà³à²Ÿà³ à²µà²¿à²µà²°à²—à²³à²¿à²—à³† à²†à²¯à³‹à²œà²•à²°à²¨à³à²¨à³ à²¸à²‚à²ªà²°à³à²•à²¿à²¸à²¬à²¹à³à²¦à³.\n\n` +
        `â€“ MPL 2026 à²†à²¯à³‹à²œà²¨à²¾ à²¸à²®à²¿à²¤à²¿`;
      sendWhatsApp(phone, msg);
    }

    // APPROVE
    async function approvePlayer(id) {
      if (!confirm("Approve this player?")) return;

      const res = await fetch(`/api/admin/approve/${id}`, { method: "POST" });
      const row = document.querySelector(`tr[data-player-id="${id}"]`);
      const name = row.dataset.playerName;
      const phone = row.dataset.playerPhone;

      alert("Player approved.");

      if (phone && confirm("Send WhatsApp approval message?")) {
        const msg =
          `à²ªà³à²°à²¿à²¯ ${name},\n\n` +
          `ðŸŽ‰ à²…à²­à²¿à²¨à²‚à²¦à²¨à³†à²—à²³à³!\nà²¨à²¿à²®à³à²® MPL 2026 à²¨à³‹à²‚à²¦à²£à²¿à²¯à²¨à³à²¨à³ à²…à²¨à³à²®à³‹à²¦à²¿à²¸à²²à²¾à²—à²¿à²¦à³†.\n\n` +
          `â€“ MPL 2026 à²†à²¯à³‹à²œà²¨à²¾ à²¸à²®à²¿à²¤à²¿`;
        sendWhatsApp(phone, msg);
      }

      loadPending();
      loadApprovedAdmin();
    }

    // REJECT
    async function rejectPlayer(id) {
      if (!confirm("Reject this player?")) return;

      const row = document.querySelector(`tr[data-player-id="${id}"]`);
      const name = row.dataset.playerName;
      const phone = row.dataset.playerPhone;

      const res = await fetch(`/api/admin/reject/${id}`, { method: "POST" });

      alert("Player rejected.");

      if (phone && confirm("Send WhatsApp rejection message?")) {
        const msg =
          `à²ªà³à²°à²¿à²¯ ${name},\n\n` +
          `à²•à³à²·à²®à²¿à²¸à²¿, à²¨à²¿à²®à³à²® MPL 2026 à²¨à³‹à²‚à²¦à²£à²¿à²¯à²¨à³à²¨à³ à²…à²¨à³à²®à³‹à²¦à²¿à²¸à²²à³ à²¸à²¾à²§à³à²¯à²µà²¾à²—à²²à²¿à²²à³à²².\n\n` +
          `â€“ MPL 2026 à²†à²¯à³‹à²œà²¨à²¾ à²¸à²®à²¿à²¤à²¿`;
        sendWhatsApp(phone, msg);
      }

      loadPending();
      loadApprovedAdmin();
    }

    // DELETE
    async function deleteApprovedPlayer(id) {
      if (!confirm("Delete permanently?")) return;
      await fetch(`/api/admin/approved-players/${id}`, { method: "DELETE" });
      loadApprovedAdmin();
    }

    // Tabs
    document.getElementById("tabPendingBtn").onclick = () => {
      pendingCard.style.display = "block";
      approvedCard.style.display = "none";
      tabPendingBtn.classList.add("active");
      tabApprovedBtn.classList.remove("active");
      loadPending();
    };

    document.getElementById("tabApprovedBtn").onclick = () => {
      pendingCard.style.display = "none";
      approvedCard.style.display = "block";
      tabApprovedBtn.classList.add("active");
      tabPendingBtn.classList.remove("active");
      loadApprovedAdmin();
    };

    loadPending();

  </script>
</body>
</html>
